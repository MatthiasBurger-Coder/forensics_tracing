# Forensics Tracing BTM Generator

This repository hosts the `de.burger.forensics.btmgen` Gradle plugin. The plugin analyses Kotlin (and optionally simple Java) sources and produces Byteman rules that capture forensic traces of call-chains, decision points, and configured variable writes. The generated Byteman script can be injected into a JVM to obtain a "glass trail" of how a function executed across the codebase.

## Features

- Generates `AT ENTRY` / `AT EXIT` rules for functions and methods to trace call-chains.
- Adds decision tracing for `if`, `when`, and `is` expressions, including true/false branches.
- Emits `AFTER WRITE` rules for user-selected local variables.
- Provides an opt-in naive Java parser for additional coverage.
- Uses Kotlin PSI via `kotlin-compiler-embeddable`, no IDE dependencies required.

## Getting Started

```kotlin
plugins {
    id("de.burger.forensics.btmgen") version "1.0.0"
}

forensicsBtmGen {
    srcDirs.set(listOf("src/main/kotlin"))
    pkgPrefix.set("de.shop.app")
    helperFqn.set("de.burger.forensics.ForensicsHelper")
    entryExit.set(true)
    trackedVars.set(listOf("approved", "status"))
    includeJava.set(false)
}
```

Run the generator to produce Byteman rules in sharded files such as `build/forensics/tracing-0001.btm`:

```bash
./gradlew generateBtmRules
```

## Generated Rule Highlights

- **Call Chain:** Every selected function produces paired `enter` and `exit` helper calls, revealing the invocation order.
- **Decisions:** Conditions are logged with `iff`, `sw`, and `kase` helper calls for `if`/`when`/`is` constructs. Each rule preserves the original line number to keep the trace mappable to source.
- **Variable Writes:** Configure `trackedVars` to capture value flips with `writeVar` rules.

### Example Bootstrap Snippet

```byteman
RULE bootstrap@Forensics
CLASS *
METHOD *
HELPER de.burger.forensics.ForensicsHelper
AT ENTRY
IF true
DO startTrace("/var/log/forensics.log"), setQuota(5000), enableSampling(10)
ENDRULE

RULE shutdown@Forensics
CLASS *
METHOD *
HELPER de.burger.forensics.ForensicsHelper
AT EXIT
IF true
DO stopTrace()
ENDRULE
```

## Kotlin Specifics

- Top-level functions appear under the synthetic `<FileName>Kt` class, matching Kotlin's JVM naming conventions.
- Nested classes and objects translate to JVM binary names using `$` separators.
- Property writes use the generated setter (`setX`) methods; configure `trackedVars` to observe local variable assignments.
- Inline and suspend functions follow the standard Kotlin compilation model; the plugin operates on the PSI and preserves their logical structure.

## Continuous Delivery

Publishing to the Gradle Plugin Portal and Maven Central is ready via GitHub Actions (see `.github/workflows/release.yml`). Provide the required credentials as repository secrets to enable automated releases when tagging versions (`v*`).

For more details on Byteman, visit [https://byteman.jboss.org/](https://byteman.jboss.org/).
